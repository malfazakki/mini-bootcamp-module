# Materi 3.1: Integrasi Database PostgreSQL

## ðŸ—„ï¸ Apa itu Database?

**Database** adalah sistem penyimpanan data terstruktur yang:
- ðŸ’¾ Menyimpan data **permanen** (tidak hilang saat server restart)
- ðŸ” Memudahkan **pencarian** & **query** data
- ðŸ” Menjaga **integritas** & **keamanan** data
- âš¡ Mendukung operasi data yang **cepat** & **efisien**

**ðŸ’¡ Analogi:**
- **Array di memory** = Sticky notes (hilang saat komputer mati)
- **Database** = Filling cabinet yang organized (data tetap ada)

---

## ðŸ˜ Apa itu PostgreSQL?

**PostgreSQL** (sering disebut **Postgres**) adalah sistem database **relational** (RDBMS) yang:
- âœ… Open source & gratis
- âœ… Powerful & reliable
- âœ… Dipakai perusahaan besar (Instagram, Spotify, Netflix)
- âœ… Support advanced features (JSON, full-text search, dll)

**Alternatif lain:** MySQL, SQLite, MariaDB

**Kenapa PostgreSQL?**
- Standard industri
- Well-documented
- Active community
- Free tier di cloud (Supabase, Neon, ElephantSQL)

---

## â˜ï¸ Setup PostgreSQL (Cloud - Mudah!)

Untuk pembelajaran, kita pakai **database cloud gratis**. Recommended: **Supabase** atau **Neon**.

### **Option 1: Supabase** (RECOMMENDED)

1. **Daftar** di https://supabase.com
2. **Create New Project**
   - Nama project: `todo-db`
   - Password database: (simpan baik-baik!)
   - Region: Singapore
3. **Tunggu ~2 menit** sampai project ready
4. **Copy Connection String:**
   - Pergi ke Settings â†’ Database
   - Copy **Connection String** (URI format)
   - Contoh: `postgresql://postgres:[PASSWORD]@db.xxx.supabase.co:5432/postgres`

---

### **Option 2: Neon.tech**

1. Daftar di https://neon.tech
2. Create project
3. Copy connection string

---

### **Option 3: Install Lokal (Advanced)**

Jika mau install di komputer:
- **Windows:** Download dari https://www.postgresql.org/download/
- **Mac:** `brew install postgresql`
- **Linux:** `sudo apt-get install postgresql`

**ðŸ’¡ Untuk pemula, gunakan CLOUD lebih mudah!**

---

## ðŸ“Š SQL Dasar yang Harus Diketahui

**SQL** (Structured Query Language) = Bahasa untuk komunikasi dengan database.

### **1. CREATE TABLE (Buat Tabel)**

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**Penjelasan:**
- `SERIAL` = Auto-increment (ID otomatis naik)
- `PRIMARY KEY` = Unique identifier
- `VARCHAR(100)` = String maksimal 100 karakter
- `NOT NULL` = Wajib diisi
- `UNIQUE` = Nilai harus unik (tidak boleh duplikat)
- `TIMESTAMP` = Tanggal & waktu
- `DEFAULT NOW()` = Default value saat ini

---

### **2. INSERT (Tambah Data)**

```sql
INSERT INTO users (name, email, password)
VALUES ('Budi Santoso', 'budi@email.com', 'hashed_password');
```

---

### **3. SELECT (Ambil Data)**

```sql
-- Ambil semua data
SELECT * FROM users;

-- Ambil kolom tertentu
SELECT name, email FROM users;

-- Dengan kondisi WHERE
SELECT * FROM users WHERE id = 1;
SELECT * FROM users WHERE email = 'budi@email.com';

-- Dengan ORDER BY
SELECT * FROM users ORDER BY created_at DESC;

-- Dengan LIMIT
SELECT * FROM users LIMIT 10;
```

---

### **4. UPDATE (Ubah Data)**

```sql
UPDATE users
SET name = 'Budi Wijaya', email = 'budi.new@email.com'
WHERE id = 1;
```

---

### **5. DELETE (Hapus Data)**

```sql
DELETE FROM users WHERE id = 1;

-- Hapus semua (HATI-HATI!)
DELETE FROM users;
```

---

## ðŸ”Œ Koneksi PostgreSQL dari Node.js

### **Install Library `pg`**

```bash
npm install pg
npm install dotenv  # Untuk environment variables
```

---

### **Setup Environment Variables**

Buat file `.env` di root project:

```env
DATABASE_URL=postgresql://postgres:password@db.xxx.supabase.co:5432/postgres                                                                                                                                                                                                                                                           
PORT=3000
```

**âš ï¸ PENTING:** Tambahkan `.env` ke `.gitignore`!

```
# .gitignore
node_modules/
.env
```

---

### **Koneksi Database - `db.js`**

```javascript
const { Pool } = require('pg');
require('dotenv').config();

// Create connection pool
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false  // Untuk cloud database
    }
});

// Test koneksi
pool.connect((err, client, release) => {
    if (err) {
        return console.error('âŒ Error connecting to database:', err.stack);
    }
    console.log('âœ… Connected to PostgreSQL database');
    release();
});

module.exports = pool;
```

---

## ðŸ—ï¸ Buat Tabel Todos

### **File: `schema.sql`**

```sql
CREATE TABLE IF NOT EXISTS todos (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Insert sample data
INSERT INTO todos (title, completed) VALUES
('Belajar Node.js', false),
('Buat API', false),
('Deploy ke production', false);
```

**Cara Run:**
1. Buka **SQL Editor** di dashboard Supabase
2. Copy-paste SQL di atas
3. Run!

---

## ðŸ”§ CRUD dengan Database

### **File: `server.js`**

```javascript
const express = require('express');
const db = require('./db');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

// ========== ROUTES ==========

// CREATE - Add new todo
app.post('/api/todos', async (req, res) => {
    try {
        const { title } = req.body;
        
        // Validasi
        if (!title || title.trim() === '') {
            return res.status(400).json({
                success: false,
                message: 'Title is required'
            });
        }
        
        // Insert ke database
        const result = await db.query(
            'INSERT INTO todos (title) VALUES ($1) RETURNING *',
            [title.trim()]
        );
        
        res.status(201).json({
            success: true,
            message: 'Todo created successfully',
            data: result.rows[0]
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// READ - Get all todos
app.get('/api/todos', async (req, res) => {
    try {
        const result = await db.query(
            'SELECT * FROM todos ORDER BY created_at DESC'
        );
        
        res.json({
            success: true,
            count: result.rows.length,
            data: result.rows
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// READ - Get single todo
app.get('/api/todos/:id', async (req, res) => {
    try {
        const { id } = req.params;
        
        const result = await db.query(
            'SELECT * FROM todos WHERE id = $1',
            [id]
        );
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Todo not found'
            });
        }
        
        res.json({
            success: true,
            data: result.rows[0]
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// UPDATE - Update todo
app.put('/api/todos/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { title, completed } = req.body;
        
        // Cek apakah todo exists
        const checkResult = await db.query(
            'SELECT * FROM todos WHERE id = $1',
            [id]
        );
        
        if (checkResult.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Todo not found'
            });
        }
        
        // Update
        const result = await db.query(
            'UPDATE todos SET title = COALESCE($1, title), completed = COALESCE($2, completed), updated_at = NOW() WHERE id = $3 RETURNING *',
            [title, completed, id]
        );
        
        res.json({
            success: true,
            message: 'Todo updated successfully',
            data: result.rows[0]
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// PATCH - Toggle completed
app.patch('/api/todos/:id/toggle', async (req, res) => {
    try {
        const { id } = req.params;
        
        const result = await db.query(
            'UPDATE todos SET completed = NOT completed, updated_at = NOW() WHERE id = $1 RETURNING *',
            [id]
        );
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Todo not found'
            });
        }
        
        res.json({
            success: true,
            message: 'Todo status toggled',
            data: result.rows[0]
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// DELETE - Delete todo
app.delete('/api/todos/:id', async (req, res) => {
    try {
        const { id } = req.params;
        
        const result = await db.query(
            'DELETE FROM todos WHERE id = $1 RETURNING *',
            [id]
        );
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Todo not found'
            });
        }
        
        res.json({
            success: true,
            message: 'Todo deleted successfully'
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// ========== START SERVER ==========

app.listen(PORT, () => {
    console.log(`ðŸš€ Server running on http://localhost:${PORT}`);
});
```

---

## ðŸ”’ SQL Injection Prevention

**âŒ BAHAYA! (SQL Injection vulnerable):**
```javascript
const query = `SELECT * FROM users WHERE email = '${email}'`;
```

**âœ… AMAN (Parameterized query):**
```javascript
const query = 'SELECT * FROM users WHERE email = $1';
const result = await db.query(query, [email]);
```

**Selalu gunakan `$1, $2, $3...` untuk parameters!**

---

## ðŸ“Š Query dengan Filtering

```javascript
app.get('/api/todos/search', async (req, res) => {
    try {
        const { q } = req.query;
        
        const result = await db.query(
            'SELECT * FROM todos WHERE title ILIKE $1',
            [`%${q}%`]  // % = wildcard
        );
        
        res.json({
            success: true,
            count: result.rows.length,
            data: result.rows
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});
```

**Test:**
```
GET /api/todos/search?q=belajar
```

---

## âœ… Latihan Praktik

**Latihan 1:** Buat tabel `products` dengan kolom:
- id, name, price, stock, created_at
- Buat CRUD API lengkap

**Latihan 2:** Tambahkan fitur:
- Filter products by price range
- Search products by name
- Get products with stock < 10

**Latihan 3:** Buat tabel `categories` dan relasi dengan `products` (1 product punya 1 category).

---

## ðŸŽ¯ Yang Harus Dikuasai:

- âœ… Setup PostgreSQL (cloud)
- âœ… SQL dasar (CREATE, INSERT, SELECT, UPDATE, DELETE)
- âœ… Koneksi Node.js ke PostgreSQL (library `pg`)
- âœ… CRUD dengan database
- âœ… Parameterized queries (prevent SQL injection)
- âœ… Error handling async/await
- âœ… Environment variables (.env)

---

**ðŸ’¡ Tips:**
- **Selalu gunakan** parameterized queries ($1, $2, ...)
- **Try-catch** untuk semua database operations
- **Log errors** untuk debugging
- **Test di SQL Editor** dulu sebelum implement di code
- **Gunakan tools** seperti **Table Plus** atau **DBeaver** untuk GUI database
- **Backup database** secara regular! ðŸš€

**ðŸŽŠ SELAMAT! Anda sudah menyelesaikan HARI 3!**

Besok kita akan integrasikan Frontend dengan Backend dan deploy aplikasi ke cloud!
