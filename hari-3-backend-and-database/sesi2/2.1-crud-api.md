# Materi 2.1: CRUD API dengan Express

## ðŸŽ¯ Apa itu CRUD?

**CRUD** adalah akronim untuk operasi dasar pada data:
- **C**reate - Membuat data baru
- **R**ead - Membaca/mengambil data
- **U**pdate - Mengubah data yang sudah ada
- **D**elete - Menghapus data

**ðŸ’¡ Analogi:**
CRUD seperti operasi pada **buku telepon**:
- **Create:** Tambah kontak baru
- **Read:** Lihat daftar kontak atau cari kontak tertentu
- **Update:** Ubah nomor HP kontak
- **Delete:** Hapus kontak

---

## ðŸ—ºï¸ Mapping CRUD ke HTTP Methods

| CRUD | HTTP Method | Endpoint | Deskripsi |
|------|-------------|----------|-----------|
| **Create** | POST | `/api/items` | Buat item baru |
| **Read All** | GET | `/api/items` | Ambil semua item |
| **Read One** | GET | `/api/items/:id` | Ambil 1 item by ID |
| **Update** | PUT/PATCH | `/api/items/:id` | Update item by ID |
| **Delete** | DELETE | `/api/items/:id` | Hapus item by ID |

---

## ðŸ—ï¸ Project: Todo API (Full CRUD)

Kita akan membuat **Todo API** lengkap dengan semua operasi CRUD!

### **Setup Project**

```bash
mkdir todo-api
cd todo-api
npm init -y
npm install express
npm install --save-dev nodemon
```

**Update `package.json`:**
```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  }
}
```

---

### **File: `server.js`**

```javascript
const express = require('express');
const app = express();
const PORT = 3000;

// Middleware
app.use(express.json());

// Data sementara (dalam memory)
let todos = [
    { id: 1, title: 'Belajar Node.js', completed: false, createdAt: new Date() },
    { id: 2, title: 'Buat API', completed: false, createdAt: new Date() },
    { id: 3, title: 'Deploy ke server', completed: false, createdAt: new Date() }
];

// Counter untuk ID
let nextId = 4;

// ========== ROUTES ==========

// READ - Get all todos
app.get('/api/todos', (req, res) => {
    res.json({
        success: true,
        count: todos.length,
        data: todos
    });
});

// READ - Get single todo by ID
app.get('/api/todos/:id', (req, res) => {
    const id = parseInt(req.params.id);
    const todo = todos.find(t => t.id === id);
    
    if (!todo) {
        return res.status(404).json({
            success: false,
            message: `Todo with ID ${id} not found`
        });
    }
    
    res.json({
        success: true,
        data: todo
    });
});

// CREATE - Add new todo
app.post('/api/todos', (req, res) => {
    const { title } = req.body;
    
    // Validasi
    if (!title || title.trim() === '') {
        return res.status(400).json({
            success: false,
            message: 'Title is required'
        });
    }
    
    // Buat todo baru
    const newTodo = {
        id: nextId++,
        title: title.trim(),
        completed: false,
        createdAt: new Date()
    };
    
    todos.push(newTodo);
    
    res.status(201).json({
        success: true,
        message: 'Todo created successfully',
        data: newTodo
    });
});

// UPDATE - Update todo
app.put('/api/todos/:id', (req, res) => {
    const id = parseInt(req.params.id);
    const { title, completed } = req.body;
    
    // Cari todo
    const todoIndex = todos.findIndex(t => t.id === id);
    
    if (todoIndex === -1) {
        return res.status(404).json({
            success: false,
            message: `Todo with ID ${id} not found`
        });
    }
    
    // Update
    if (title !== undefined) {
        todos[todoIndex].title = title.trim();
    }
    
    if (completed !== undefined) {
        todos[todoIndex].completed = completed;
    }
    
    todos[todoIndex].updatedAt = new Date();
    
    res.json({
        success: true,
        message: 'Todo updated successfully',
        data: todos[todoIndex]
    });
});

// PATCH - Toggle completed status
app.patch('/api/todos/:id/toggle', (req, res) => {
    const id = parseInt(req.params.id);
    const todo = todos.find(t => t.id === id);
    
    if (!todo) {
        return res.status(404).json({
            success: false,
            message: `Todo with ID ${id} not found`
        });
    }
    
    // Toggle
    todo.completed = !todo.completed;
    todo.updatedAt = new Date();
    
    res.json({
        success: true,
        message: 'Todo status toggled',
        data: todo
    });
});

// DELETE - Delete todo
app.delete('/api/todos/:id', (req, res) => {
    const id = parseInt(req.params.id);
    const initialLength = todos.length;
    
    // Filter out the todo to delete
    todos = todos.filter(t => t.id !== id);
    
    if (todos.length === initialLength) {
        return res.status(404).json({
            success: false,
            message: `Todo with ID ${id} not found`
        });
    }
    
    res.json({
        success: true,
        message: 'Todo deleted successfully'
    });
});

// DELETE - Delete all completed todos
app.delete('/api/todos/completed/all', (req, res) => {
    const initialLength = todos.length;
    todos = todos.filter(t => !t.completed);
    const deletedCount = initialLength - todos.length;
    
    res.json({
        success: true,
        message: `Deleted ${deletedCount} completed todos`,
        deletedCount
    });
});

// ========== EXTRA FEATURES ==========

// Get statistics
app.get('/api/todos/stats', (req, res) => {
    const total = todos.length;
    const completed = todos.filter(t => t.completed).length;
    const pending = total - completed;
    
    res.json({
        success: true,
        data: {
            total,
            completed,
            pending,
            completionRate: total > 0 ? ((completed / total) * 100).toFixed(2) + '%' : '0%'
        }
    });
});

// Search todos
app.get('/api/todos/search', (req, res) => {
    const { q } = req.query;
    
    if (!q) {
        return res.status(400).json({
            success: false,
            message: 'Query parameter "q" is required'
        });
    }
    
    const results = todos.filter(t => 
        t.title.toLowerCase().includes(q.toLowerCase())
    );
    
    res.json({
        success: true,
        count: results.length,
        data: results
    });
});

// ========== START SERVER ==========

app.listen(PORT, () => {
    console.log(`ðŸš€ Server running on http://localhost:${PORT}`);
    console.log(`ðŸ“ Endpoints:`);
    console.log(`   GET    /api/todos`);
    console.log(`   GET    /api/todos/:id`);
    console.log(`   POST   /api/todos`);
    console.log(`   PUT    /api/todos/:id`);
    console.log(`   PATCH  /api/todos/:id/toggle`);
    console.log(`   DELETE /api/todos/:id`);
    console.log(`   GET    /api/todos/stats`);
    console.log(`   GET    /api/todos/search?q=keyword`);
});
```

---

## ðŸ§ª Testing dengan Postman

### **1. CREATE - POST /api/todos**

**Request:**
```
POST http://localhost:3000/api/todos
Content-Type: application/json

{
    "title": "Belajar Express"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Todo created successfully",
    "data": {
        "id": 4,
        "title": "Belajar Express",
        "completed": false,
        "createdAt": "2026-01-20T02:00:00.000Z"
    }
}
```

---

### **2. READ - GET /api/todos**

**Request:**
```
GET http://localhost:3000/api/todos
```

**Response:**
```json
{
    "success": true,
    "count": 4,
    "data": [
        {
            "id": 1,
            "title": "Belajar Node.js",
            "completed": false,
            "createdAt": "..."
        },
        // ... dst
    ]
}
```

---

### **3. READ ONE - GET /api/todos/1**

**Request:**
```
GET http://localhost:3000/api/todos/1
```

**Response:**
```json
{
    "success": true,
    "data": {
        "id": 1,
        "title": "Belajar Node.js",
        "completed": false,
        "createdAt": "..."
    }
}
```

---

### **4. UPDATE - PUT /api/todos/1**

**Request:**
```
PUT http://localhost:3000/api/todos/1
Content-Type: application/json

{
    "title": "Belajar Node.js & Express",
    "completed": true
}
```

**Response:**
```json
{
    "success": true,
    "message": "Todo updated successfully",
    "data": {
        "id": 1,
        "title": "Belajar Node.js & Express",
        "completed": true,
        "createdAt": "...",
        "updatedAt": "..."
    }
}
```

---

### **5. DELETE - DELETE /api/todos/1**

**Request:**
```
DELETE http://localhost:3000/api/todos/1
```

**Response:**
```json
{
    "success": true,
    "message": "Todo deleted successfully"
}
```

---

## ðŸŽ¨ Best Practices CRUD API

### **1. Konsisten Response Format**

```javascript
// Success
{
    "success": true,
    "data": { ... }
}

// Error
{
    "success": false,
    "message": "Error message",
    "errors": { ... }  // Optional validation errors
}
```

---

### **2. Proper HTTP Status Codes**

```javascript
// Success
res.status(200).json({ ... });        // OK (GET, PUT, PATCH)
res.status(201).json({ ... });        // Created (POST)
res.status(204).send();               // No Content (DELETE)

// Client Errors
res.status(400).json({ ... });        // Bad Request
res.status(404).json({ ... });        // Not Found
res.status(422).json({ ... });        // Validation Error

// Server Errors
res.status(500).json({ ... });        // Internal Server Error
```

---

### **3. Validasi Input**

```javascript
app.post('/api/todos', (req, res) => {
    const { title } = req.body;
    
    // Validasi
    const errors = {};
    
    if (!title) {
        errors.title = 'Title is required';
    } else if (title.length < 3) {
        errors.title = 'Title must be at least 3 characters';
    } else if (title.length > 100) {
        errors.title = 'Title must not exceed 100 characters';
    }
    
    if (Object.keys(errors).length > 0) {
        return res.status(400).json({
            success: false,
            message: 'Validation failed',
            errors
        });
    }
    
    // Lanjut create...
});
```

---

### **4. Error Handling**

```javascript
app.get('/api/todos/:id', (req, res) => {
    try {
        const id = parseInt(req.params.id);
        
        // Validasi ID
        if (isNaN(id)) {
            return res.status(400).json({
                success: false,
                message: 'Invalid ID format'
            });
        }
        
        const todo = todos.find(t => t.id === id);
        
        if (!todo) {
            return res.status(404).json({
                success: false,
                message: `Todo with ID ${id} not found`
            });
        }
        
        res.json({
            success: true,
            data: todo
        });
        
    } catch (error) {
        console.error(error);
        res.status(500).json({
            success: false,
            message: 'Internal server error'
        });
    }
});
```

---

### **5. Filtering & Pagination**

```javascript
app.get('/api/todos', (req, res) => {
    const { status, page = 1, limit = 10 } = req.query;
    
    let filteredTodos = todos;
    
    // Filter by status
    if (status === 'completed') {
        filteredTodos = filteredTodos.filter(t => t.completed);
    } else if (status === 'pending') {
        filteredTodos = filteredTodos.filter(t => !t.completed);
    }
    
    // Pagination
    const startIndex = (page - 1) * limit;
    const endIndex = startIndex + parseInt(limit);
    const paginatedTodos = filteredTodos.slice(startIndex, endIndex);
    
    res.json({
        success: true,
        page: parseInt(page),
        limit: parseInt(limit),
        total: filteredTodos.length,
        count: paginatedTodos.length,
        data: paginatedTodos
    });
});
```

**Test:**
```
GET /api/todos?status=completed&page=1&limit=5
```

---

## âœ… Latihan Praktik

**Latihan 1:** Tambahkan fitur:
- Endpoint untuk update hanya title (`PATCH /api/todos/:id/title`)
- Endpoint untuk delete semua todos (`DELETE /api/todos`)

**Latihan 2:** Buat validasi lengkap:
- Title tidak boleh kosong
- Title minimal 3 karakter
- Title maksimal 100 karakter

**Latihan 3:** Buat CRUD API untuk **Product**:
```
- Product punya: id, name, price, stock
- Buat semua endpoint CRUD
- Tambahkan filter by price range
- Tambahkan search by name
```

---

## ðŸŽ¯ Yang Harus Dikuasai:

- âœ… Konsep CRUD dan mapping ke HTTP methods
- âœ… Implementasi semua operasi CRUD
- âœ… Request validation
- âœ… Proper status codes (200, 201, 400, 404)
- âœ… Consistent response format
- âœ… Error handling
- âœ… Filtering & pagination
- âœ… Testing dengan Postman

---

**ðŸ’¡ Tips:**
- **Validasi** di awal sebelum proses data
- **Return early** untuk error cases
- **Gunakan try-catch** untuk unexpected errors
- **Log errors** untuk debugging (`console.error`)
- **Test semua endpoints** dengan berbagai skenario (sukses & gagal)
- **Document API** dengan Postman Collection ðŸš€

**ðŸŽŠ Next:** Kita akan hubungkan API ke database PostgreSQL agar data permanent!
