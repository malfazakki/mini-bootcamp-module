# Materi 2.2: Deployment Backend (Render.com)

## ðŸ–¥ï¸ Mengapa Deploy Backend?

Backend harus running 24/7 di server agar API bisa diakses kapan saja!

**ðŸ’¡ Analogi:**
- **Local backend** = Warung di rumah (hanya bisa beli kalau pemilik di rumah)
- **Deployed backend** = Toko di mall (buka 24/7, siapa saja bisa akses)

---

## â˜ï¸ Platform Deployment Backend (Gratis!)

| Platform | Free Tier | Kelebihan | Kekurangan |
|----------|-----------|-----------|------------|
| **Render.com** | 750 jam/bulan | Mudah, PostgreSQL gratis | Spin down after 15 min idle |
| **Railway.app** | $5 credit/month | Fast, modern UI | Credit terbatas |
| **Fly.io** | Generous free tier | Global deployment | Setup agak rumit |
| **Cyclic.sh** | Unlimited | Sangat mudah | Database terbatas |

**Untuk bootcamp ini:** **Render.com** â­

---

## ðŸš€ Deployment dengan Render.com

### **ðŸ“‹ Prerequisites**

- âœ… Backend project sudah di GitHub
- âœ… Database sudah setup (Supabase/Neon)
- âœ… Backend tested & berfungsi di local
- âœ… File `.env` di `.gitignore`

---

### **Step 1: Persiapan Backend**

#### **1. Pastikan `package.json` Lengkap**

```json
{
  "name": "my-backend",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.0",
    "cors": "^2.8.5",
    "dotenv": "^16.0.3"
  }
}
```

**ðŸ’¡ Penting:** `"start": "node server.js"` (tanpa nodemon!)

---

#### **2. Update `server.js` - Dynamic Port**

```javascript
const express = require('express');
const cors = require('cors');
const db = require('./db');
require('dotenv').config();

const app = express();

// Middleware
app.use(cors());
app.use(express.json());

// Routes
app.get('/', (req, res) => {
    res.json({ message: 'API is running!' });
});

app.get('/api/todos', async (req, res) => {
    try {
        const result = await db.query('SELECT * FROM todos ORDER BY created_at DESC');
        res.json({ success: true, data: result.rows });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// ... routes lainnya

// PORT - PENTING: Pakai process.env.PORT!
const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
    console.log(`ðŸš€ Server running on port ${PORT}`);
});
```

**âš ï¸ WAJIB:** `const PORT = process.env.PORT || 3000;`

---

#### **3. `.gitignore`**

```
node_modules/
.env
.DS_Store
```

---

#### **4. Push ke GitHub**

```bash
git add .
git commit -m "Prepare for deployment"
git push origin main
```

---

### **Step 2: Deploy ke Render**

#### **1. Daftar/Login Render**
- Buka https://render.com
- Click **"Get Started"**
- Sign up dengan **GitHub account**

---

#### **2. Create New Web Service**
- Click **"New +"** â†’ **"Web Service"**
- Connect GitHub repository
- Pilih repository backend Anda

---

#### **3. Configure Service**

```
Name: my-backend-api
Region: Singapore (pilih yang terdekat)
Branch: main
Runtime: Node
Build Command: npm install
Start Command: npm start
Instance Type: Free
```

**ðŸ’¡ Start Command harus:** `npm start` (bukan `node server.js`)

---

#### **4. Add Environment Variables**

Click **"Advanced"** â†’ **Environment Variables**

Tambahkan:
```
DATABASE_URL = postgresql://user:password@host:5432/database
NODE_ENV = production
```

**ðŸ’¡ Copy DATABASE_URL dari Supabase/Neon!**

---

#### **5. Deploy!**
- Click **"Create Web Service"**
- Tunggu ~2-3 menit (build & deploy)
- Status akan berubah jadi **"Live" ðŸŸ¢** jika sukses

---

### **Step 3: Test API**

Render akan berikan URL:
```
https://my-backend-api.onrender.com
```

**Test di browser:**
```
https://my-backend-api.onrender.com/
https://my-backend-api.onrender.com/api/todos
```

**Test dengan Postman/Thunder Client!**

---

## ðŸ”„ Auto-Deploy

**Setiap kali push ke GitHub, Render otomatis deploy ulang!**

```bash
# Update code
git add .
git commit -m "Add new feature"
git push

# âœ… Render auto-deploy!
```

**Lihat progress deploy di Render Dashboard â†’ Logs**

---

## ðŸ› Troubleshooting Deployment

### **1. Build Failed**

**Error:** `npm install` gagal

**Solusi:**
```bash
# Test di local
npm install

# Pastikan package.json valid
# Cek dependencies version
```

---

### **2. Application Failed to Start**

**Error:** Server tidak jalan

**Solusi:**
- Cek **Logs** di Render dashboard
- Pastikan `PORT = process.env.PORT`
- Pastikan start command: `npm start`
- Cek error di console log

---

### **3. Database Connection Error**

**Error:** `ECONNREFUSED` atau `connection timeout`

**Solusi:**
- Cek `DATABASE_URL` benar
- Pastikan database cloud accessible dari internet
- Tambahkan SSL config jika perlu:
```javascript
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false
    }
});
```

---

### **4. CORS Error**

**Error:** Frontend tidak bisa akses API

**Solusi:**
```javascript
// Enable CORS untuk semua origins
app.use(cors());

// Atau spesifik origin
app.use(cors({
    origin: 'https://myfrontend.vercel.app',
    credentials: true
}));
```

---

### **5. Free Tier Spin Down**

**Masalah:** API lambat di request pertama (cold start)

**Penyebab:** Render free tier "tidur" setelah 15 menit tidak ada traffic

**Solusi:**
- Upgrade ke paid tier ($7/month - always on)
- Atau, buat cron job untuk ping API setiap 10 menit:
```javascript
// Pakai cron-job.org atau UptimeRobot
// Ping: https://mybackend.onrender.com/health setiap 10 menit
```

---

## ðŸ” Environment Variables Best Practices

### **Jangan Hardcode!**

**âŒ Bad:**
```javascript
const DATABASE_URL = 'postgresql://user:pass@host:5432/db';
const JWT_SECRET = 'mysecretkey123';
```

**âœ… Good:**
```javascript
require('dotenv').config();

const DATABASE_URL = process.env.DATABASE_URL;
const JWT_SECRET = process.env.JWT_SECRET;
```

---

### **Di Render Dashboard:**

Add semua environment variables:
```
DATABASE_URL = postgres://...
PORT = 3000
NODE_ENV = production
JWT_SECRET = your_secret_here
FRONTEND_URL = https://myfrontend.vercel.app
```

---

## ðŸ”— Hubungkan Frontend dengan Backend

### **Update Frontend `script.js`:**

```javascript
// âŒ Lama (hardcoded localhost)
const API_URL = 'http://localhost:3000/api/todos';

// âœ… Baru (pakai production URL)
const API_URL = 'https://my-backend-api.onrender.com/api/todos';

// Atau pakai conditional:
const API_URL = window.location.hostname === 'localhost'
    ? 'http://localhost:3000/api/todos'
    : 'https://my-backend-api.onrender.com/api/todos';
```

---

## ðŸ“Š Monitoring & Logs

### **Lihat Logs Real-time**

Di Render Dashboard:
1. Click service Anda
2. Click **"Logs"** tab
3. Lihat real-time logs

**Contoh log:**
```
ðŸš€ Server running on port 10000
âœ… Connected to PostgreSQL database
GET /api/todos 200 45ms
POST /api/todos 201 123ms
```

---

### **Lihat Metrics**

- **CPU Usage**
- **Memory Usage**
- **Request Count**
- **Response Time**

---

## âœ… Checklist Deployment Backend

- [ ] `package.json` lengkap & valid
- [ ] `process.env.PORT` untuk dynamic port
- [ ] `.gitignore` include `node_modules` & `.env`
- [ ] CORS enabled
- [ ] Database connection tested
- [ ] Environment variables configured di Render
- [ ] Pushed ke GitHub
- [ ] Deployed & tested API endpoints
- [ ] Frontend updated dengan production API URL
- [ ] Monitoring & logs checked

---

## ðŸŽ¯ Best Practices

### **1. Health Check Endpoint**

```javascript
app.get('/health', (req, res) => {
    res.json({
        status: 'OK',
        timestamp: new Date(),
        uptime: process.uptime()
    });
});
```

---

### **2. Error Logging**

```javascript
app.use((error, req, res, next) => {
    console.error('Error:', error);
    res.status(500).json({
        success: false,
        message: 'Internal server error'
    });
});
```

---

### **3. API Documentation**

Buat README.md dengan endpoints:
```markdown
# API Documentation

Base URL: https://my-backend-api.onrender.com

## Endpoints

### Get All Todos
GET /api/todos

### Create Todo
POST /api/todos
Body: { "title": "Todo title" }

### Delete Todo
DELETE /api/todos/:id
```

---

## ðŸŽ¯ Yang Harus Dikuasai:

- âœ… Setup backend untuk production
- âœ… Dynamic PORT configuration
- âœ… Deploy ke Render.com
- âœ… Environment variables
- âœ… Auto-deploy dari GitHub
- âœ… Troubleshooting deployment errors
- âœ… Monitoring & logging
- âœ… Connect frontend dengan production backend

---

**ðŸ’¡ Tips:**
- Test **semua endpoints** setelah deploy
- **Bookmark** production URL
- Gunakan **Postman** untuk document & test API
- Setup **monitoring** untuk track uptime
- **Logs** adalah teman terbaik saat debugging! ðŸš€

**ðŸŽŠ SELAMAT! Backend Anda sudah LIVE!**

Next: Final project & presentation!
